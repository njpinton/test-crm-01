{% extends "base.html" %}
{% load humanize %}

{% block title %}Schedule Pipeline - CRM System{% endblock %}
{% block page_title %}Schedule Pipeline{% endblock %}

{% block extra_css %}
<style>
    .kanban-column {
        min-height: calc(100vh - 250px);
    }
    .schedule-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }
    .drop-zone-active {
        background-color: rgba(99, 102, 241, 0.1);
        border: 2px dashed #6366f1;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="scheduleKanban()" class="h-full">
    <!-- Header with view toggle -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-4">
            <div class="flex bg-gray-100 rounded-lg p-1">
                <a href="{% url 'pipeline:kanban' %}"
                   class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                    Deals
                </a>
                <a href="{% url 'pipeline:schedule_kanban' %}"
                   class="px-4 py-2 text-sm font-medium rounded-md bg-white shadow text-gray-700">
                    Schedules
                </a>
            </div>

            <span class="text-sm text-gray-500">
                Active Schedules: <strong id="total-active-count" class="text-gray-900">{{ total_active }}</strong>
            </span>
            {% if cancelled_count %}
            <span class="text-sm text-gray-500">
                | Cancelled: <span class="text-red-600">{{ cancelled_count }}</span>
            </span>
            {% endif %}
        </div>

        <div class="flex items-center space-x-4">
            <span class="text-xs text-gray-500">Drag cards to move through workflow</span>
        </div>
    </div>

    <!-- Kanban Board -->
    <div class="flex gap-4 overflow-x-auto pb-4" style="min-height: calc(100vh - 250px);">
        {% for status_data in statuses %}
        <div class="kanban-column flex-shrink-0 w-72 bg-gray-100 rounded-lg p-3"
             data-status="{{ status_data.status.value }}"
             @dragover.prevent="onDragOver($event)"
             @dragleave="onDragLeave($event)"
             @drop="onDrop($event, '{{ status_data.status.value }}')">

            <!-- Column Header -->
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center">
                    <h3 class="font-semibold text-gray-900 text-sm">{{ status_data.status.label }}</h3>
                    <span id="count-{{ status_data.status.value }}" class="ml-2 px-2 py-0.5 text-xs font-medium
                        {% if status_data.status.value == 'COMPLETED' %}bg-green-200 text-green-800
                        {% elif status_data.status.value == 'NEW_REQUEST' %}bg-blue-200 text-blue-800
                        {% elif status_data.status.value == 'SITE_OFFICER_ASSIGNED' %}bg-purple-200 text-purple-800
                        {% elif status_data.status.value == 'SCHEDULED' %}bg-indigo-200 text-indigo-800
                        {% elif status_data.status.value == 'IN_PROGRESS' %}bg-yellow-200 text-yellow-800
                        {% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">
                        {{ status_data.count }}
                    </span>
                </div>
            </div>

            <!-- Schedule Cards -->
            <div class="space-y-2 min-h-[100px]" id="status-{{ status_data.status.value }}">
                {% for schedule in status_data.schedules %}
                {% include "pipeline/partials/schedule_card.html" %}
                {% empty %}
                <div class="text-center py-6 text-gray-400 text-sm">
                    No schedules
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Assignment Modal -->
<div id="assign-modal"
     x-data="{ open: false }"
     @schedule-assign-modal.window="open = true; $refs.modalContent.innerHTML = $event.detail.html"
     @keydown.escape.window="open = false"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div x-show="open"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             @click="open = false"
             class="fixed inset-0 bg-black bg-opacity-50"></div>

        <div x-show="open"
             x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             x-ref="modalContent"
             class="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <!-- Modal content will be injected here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function scheduleKanban() {
    return {
        draggedScheduleId: null,
        sourceStatus: null,
        isDragging: false,

        onDragStart(event, scheduleId, status) {
            this.draggedScheduleId = scheduleId;
            this.sourceStatus = status;
            this.isDragging = true;
            event.target.classList.add('dragging', 'opacity-50');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', scheduleId);
            event.dataTransfer.setData('source-status', status);
        },

        onDragEnd(event) {
            event.target.classList.remove('dragging', 'opacity-50');
            document.querySelectorAll('.drop-zone-active').forEach(el => {
                el.classList.remove('drop-zone-active');
            });
            this.isDragging = false;
        },

        onDragOver(event) {
            if (this.isDragging) {
                event.currentTarget.classList.add('drop-zone-active');
            }
        },

        onDragLeave(event) {
            event.currentTarget.classList.remove('drop-zone-active');
        },

        onDrop(event, targetStatus) {
            event.currentTarget.classList.remove('drop-zone-active');
            const scheduleId = event.dataTransfer.getData('text/plain');
            const sourceStatus = event.dataTransfer.getData('source-status');

            // Don't move if dropping in same status
            if (sourceStatus === targetStatus) {
                return;
            }

            // Disable all card dragging during request
            document.querySelectorAll('.schedule-card').forEach(card => {
                card.setAttribute('draggable', 'false');
                card.style.cursor = 'wait';
            });

            htmx.ajax('POST', '{% url "pipeline:move_schedule" %}', {
                values: {
                    schedule_id: scheduleId,
                    status: targetStatus,
                    source_status: sourceStatus,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                target: '#status-' + targetStatus,
                swap: 'afterbegin'
            });
        }
    }
}

// Re-enable dragging after HTMX swap completes
document.body.addEventListener('htmx:afterSwap', function(event) {
    document.querySelectorAll('.schedule-card').forEach(card => {
        card.setAttribute('draggable', 'true');
        card.style.cursor = 'move';
    });

    // Check if response is assignment modal
    if (event.detail.target.id && event.detail.target.id.startsWith('status-')) {
        const response = event.detail.xhr.responseText;
        if (response.includes('assign-schedule-form')) {
            window.dispatchEvent(new CustomEvent('schedule-assign-modal', {
                detail: { html: response }
            }));
            event.detail.target.querySelector('[id^="assign-schedule-form"]')?.remove();
        }
    }
});

// Handle HTMX errors
document.body.addEventListener('htmx:responseError', function(event) {
    document.querySelectorAll('.schedule-card').forEach(card => {
        card.setAttribute('draggable', 'true');
        card.style.cursor = 'move';
    });
    console.error('HTMX error:', event.detail.error);
});

// Handle schedule assigned event
document.body.addEventListener('scheduleAssigned', function() {
    window.location.reload();
});
</script>
{% endblock %}
